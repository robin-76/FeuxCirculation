<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Projet Arduino</title>
        <h1>Projet Arduino</h1>
        <link href="index.css" type="text/css" rel="stylesheet" />

        <script type='text/javascript'>
            window.onload = function() {
                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext("2d");

                // Afficher x et y avec la souris
                /*canvas.addEventListener("mousemove", function(e) { 
                var cRect = canvas.getBoundingClientRect();        
                var canvasX = Math.round(e.clientX - cRect.left);  
                var canvasY = Math.round(e.clientY - cRect.top);   
                ctx.clearRect(0, 0, canvas.width, canvas.height);  
                ctx.fillText("X: "+canvasX+", Y: "+canvasY, 10, 20);
                });*/

                /* Dessiner rectangle
                ctx.rect(155, 262, 100, 50);
                ctx.fill();*/                

                var nbVoitures = 6;
                var timeoutID;
                var orangeFini = false, bVert = false, bRouge = false;
                var distanceArret = 120, distanceMin = 125, distanceMax = 275;
                var distanceEntreVoituresGauche = Math.floor(Math.random() * (distanceMax+1 - distanceMin) + distanceMin);
                var distanceEntreVoituresDroite = Math.floor(Math.random() * (distanceMax+1 - distanceMin) + distanceMin);

                var tabVoitureStopGauche = new Array(), tabVoitureStopDroite = new Array();

                // anciennes positions X des voitures
                var tabOldXGauche = new Array(), tabOldXDroite = new Array();

                // positions initiales X des voitures
                var tabXGauche = new Array();
                var j = -134 // position 1ère voiture
                for(var i=0; i<nbVoitures; i++) {
                    tabXGauche[i] = j;
                    j = j-distanceEntreVoituresGauche;
                }

                var tabXDroite = new Array();
                var j = 800 // position 1ère voiture
                for(var i=0; i<nbVoitures; i++) {
                    tabXDroite[i] = j;
                    j = j+distanceEntreVoituresDroite;
                }

                // positions initiales Y des voitures
                var yGauche = 382, yDroite = 336;
                var feuGauche = 248, feuDroite = 416;
                var vitesseMin = 0.2, vitesseMax = 1.5;

                var tabImgGauche = new Array(), tabImgDroite = new Array();
                for(var i=0; i<nbVoitures; i++) {
                    tabImgGauche[i] = new Image();
                    tabImgGauche[i].src = "img/gaucheVoiture" + Math.floor((Math.random() * nbVoitures)) + ".png";
                    tabImgDroite[i] = new Image();
                    tabImgDroite[i].src = "img/droiteVoiture" + Math.floor((Math.random() * nbVoitures)) + ".png";
                }

                setInterval(deplacementVoitures, 6);

                function deplacementVoitures() {
                    canvas.width=canvas.width;       

                    for(var i=0; i<nbVoitures; i++) {
                        ctx.drawImage(tabImgGauche[i], tabXGauche[i], yGauche);
                        ctx.drawImage(tabImgDroite[i], tabXDroite[i], yDroite);
                        if(tabXGauche[i] == tabOldXGauche[i])
                            tabVoitureStopGauche[i] = true;
                        else
                            tabVoitureStopGauche[i] = false;
                        tabOldXGauche[i] = tabXGauche[i];
                        
                        if(tabXDroite[i] == tabOldXDroite[i])
                            tabVoitureStopDroite[i] = true;
                        else
                            tabVoitureStopDroite[i] = false;
                        tabOldXDroite[i] = tabXDroite[i];
                    }                       
                        
                    if(bVert) {
                        if(!orangeFini) {
                            for(var i=0; i<nbVoitures; i++) {
                                if(!tabVoitureStopGauche[i])
                                    tabXGauche[i] += Math.random() * (vitesseMax - vitesseMin) + vitesseMin
                                if(!tabVoitureStopDroite[i])
                                    tabXDroite[i] -= Math.random() * (vitesseMax - vitesseMin) + vitesseMin
                            }

                            orange();
                            timeoutID = setTimeout(vert, 600);
                        }
                        else {
                            vert();
                            for(var i=0; i<nbVoitures; i++) {
                                // La voiture n'avance que si la voiture de devant n'est pas trop proche
                                if(!parseFloat(tabXGauche[i]-tabXGauche[i+1]) < distanceMin)
                                    tabXGauche[i] += Math.random() * (vitesseMax - vitesseMin) + vitesseMin
                                if(!parseFloat(tabXDroite[i+1]-tabXDroite[i]) < distanceMin)
                                    tabXDroite[i] -= Math.random() * (vitesseMax - vitesseMin) + vitesseMin 
                            }
                        }
                    }
                    
                    if(bRouge) { 
                        for(var i=0; i<nbVoitures-1; i++) {
                            if(tabXGauche[i]-tabXGauche[i+1] < distanceArret)
                                tabVoitureStopGauche[i+1] = true;
                            else 
                                tabVoitureStopGauche[i+1] = false;
                            
                            if(tabXDroite[i+1]-tabXDroite[i] < distanceArret)
                                tabVoitureStopDroite[i+1] = true;
                            else 
                                tabVoitureStopDroite[i+1] = false;
                        }

                        for(var i=0; i<nbVoitures; i++) {
                            if((parseInt(tabXGauche[i])!=feuGauche && parseInt(tabXGauche[i])!=feuGauche-1 && parseInt(tabXGauche[i])!=feuGauche+1) && !tabVoitureStopGauche[i])
                                tabXGauche[i] += Math.random() * (vitesseMax - vitesseMin) + vitesseMin

                            if((parseInt(tabXDroite[i])!=feuDroite && parseInt(tabXDroite[i])!=feuDroite-1 && parseInt(tabXDroite[i])!=feuDroite+1) && !tabVoitureStopDroite[i])
                                tabXDroite[i] -= Math.random() * (vitesseMax - vitesseMin) + vitesseMin
                        }
                               
                        if(!orangeFini) {
                            orange();
                            timeoutID = setTimeout(rouge, 600);
                        }
                        else 
                            rouge();
                    }

                        // On recommence lorsque la dernière voiture a finit
                        if(parseInt(tabXGauche[nbVoitures-1])>800) {
                            distanceEntreVoituresGauche = Math.floor(Math.random() * (distanceMax+1 - distanceMin) + distanceMin);
                            var j = -134
                            for(var i=0; i<nbVoitures; i++) {
                                tabXGauche[i] = j;
                                j = j-distanceEntreVoituresGauche;
                                tabImgGauche[i] = new Image();
                                tabImgGauche[i].src = "img/gaucheVoiture" + Math.floor((Math.random() * nbVoitures)) + ".png";
                            }
                        }

                        if(parseInt(tabXDroite[nbVoitures-1])<-134) {
                            distanceEntreVoituresDroite = Math.floor(Math.random() * (distanceMax+1 - distanceMin) + distanceMin);
                            var j = 800
                            for(var i=0; i<nbVoitures; i++) {
                                tabXDroite[i] = j;
                                j = j+distanceEntreVoituresDroite;
                                tabImgDroite[i] = new Image();
                                tabImgDroite[i].src = "img/droiteVoiture" + Math.floor((Math.random() * nbVoitures)) + ".png";
                            }
                        }
                    }

                function vert() {
                    orangeFini = true;

                    ctx.clearRect(274, 450, 100, 50);
                    ctx.clearRect(472, 262, 100, 50);

                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(305.5, 495.2, 9, 0, 2 * Math.PI);
                    ctx.arc(324.5, 495.2, 9, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(495, 307.3, 9, 0, 2 * Math.PI);
                    ctx.arc(514, 307.3, 9, 0, 2 * Math.PI);
                    ctx.fill();
                }

                function orange() {
                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(286, 495.2, 9, 0, 2 * Math.PI);
                    ctx.arc(324, 495.2, 9, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(495, 307.3, 9, 0, 2 * Math.PI);
                    ctx.arc(534, 307.3, 9, 0, 2 * Math.PI);
                    ctx.fill();
                }

                function rouge() {
                    orangeFini = true;

                    ctx.clearRect(247, 450, 100, 50);
                    ctx.clearRect(472, 262, 100, 50);

                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(286, 495.2, 9, 0, 2 * Math.PI);
                    ctx.arc(305, 495.2, 9, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.fillStyle="#000000"
                    ctx.arc(514, 307.3, 9, 0, 2 * Math.PI);
                    ctx.arc(534, 307.3, 9, 0, 2 * Math.PI);
                    ctx.fill();
                }
                
                function boutonVert() {
                    orangeFini = false;
                    bVert = true;
                    bRouge = false;
                    //  clearTimeout(timeoutID); ne fonctionne pas

                    document.getElementById("boutonVert").disabled = true;
                    setTimeout(function(){
                        document.getElementById("boutonRouge").disabled = false;
                    }, 600);
                }
                
                function boutonRouge() {
                    orangeFini = false;
                    bRouge = true;
                    bVert = false;
                  //  clearTimeout(timeoutID); ne fontionne pas

                    document.getElementById("boutonRouge").disabled = true;
                    setTimeout(function(){
                        document.getElementById("boutonVert").disabled = false;
                    }, 500);    
                }

                document.getElementById('boutonVert').onclick = function(evt) { boutonVert(); }
                document.getElementById("boutonRouge").disabled = true;
                document.getElementById('boutonRouge').onclick = function(evt) { boutonRouge(); }
            }
            
        </script>
    </head>

    <body>
        <canvas id="canvas" width="800" height="800"></canvas>
        <input type="button" class="boutonVert" id="boutonVert" name="boutonVert" value="Vert">
        <input type="button" class="boutonRouge" id="boutonRouge" name="boutonRouge" value="Rouge">
    </body>
</html>
